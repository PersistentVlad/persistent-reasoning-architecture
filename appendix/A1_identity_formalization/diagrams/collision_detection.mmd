%% persistent-reasoning-architecture/appendix/A1_identity_formalization/diagrams/collision_detection.mmd
flowchart TD
  classDef step fill:#ffffff,stroke:#333,color:#111;
  classDef gate fill:#f5f5f5,stroke:#666,color:#111;
  classDef ok fill:#e9ffe9,stroke:#2a7f2a,color:#0f3d0f;
  classDef bad fill:#ffecec,stroke:#cc0000,color:#660000;
  classDef note fill:#f5f5f5,stroke:#999,color:#222;

  S["Start: Proposal arrives\n(op: add/replace/forget)"]:::step
  C["Compute / read declared identity\nI_proposed"]:::step
  R["Registry lookup:\nIs I_proposed already assigned?"]:::step

  S --> C --> R

  R -->|No| OK1["No collision\nProceed to structural checks"]:::ok
  R -->|Yes| P["Fetch assigned entity\nE_assigned + lineage"]:::step

  P --> EQ["Equivalence check\n(allowed only structural)\nI_proposed == I(E_assigned)?"]:::gate

  EQ -->|Same entity| OK2["Not a collision\nTreat as new version\nappend-only commit"]:::ok
  EQ -->|Different entity| BAD1["Collision detected\nBLOCK COMMIT"]:::bad

  BAD1 --> RES["Resolution required\n(governance decision):\n- reissue identity\n- explicit deprecate\n- explicit merge mapping"]:::gate

  %% Show forbidden auto-fix
  BAD1 -.-> F1["FORBIDDEN:\nAuto-dedup by similarity\n(embedding / text match)"]:::bad
  BAD1 -.-> F2["FORBIDDEN:\nSilent overwrite / reassignment"]:::bad

  NOTE["Collision is a structural fracture.\nCommit gate must refuse it.\nAny auto-fix = architectural erosion."]:::note
  RES -.-> NOTE
